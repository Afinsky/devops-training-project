pipeline{
    agent{
        label "slave1"
    }


    environment{
      registry = "10.20.40.176:8084"
    }

    stages{ 


        stage("Docker build images"){
            parallel{
                
                stage("Docker build Front image"){
                        steps{
                                sh '''
                                docker build -t 10.20.40.176:8084/frontapp -f docker/Dockerfile-front .
                                '''
                        }  
                }
                
                stage("Docker build Back image"){
                        steps{
                                sh '''
                                docker build -t 10.20.40.176:8084/backapp -f docker/Dockerfile-back .
                                '''  
                        }  
                }
            
            }
        }



        stage("Docker push images to Nexus registry"){
            parallel{
                
                stage("Docker push Front image"){
                        steps{
                            withDockerRegistry(credentialsId: 'nexus_registry', url: 'http://10.20.40.176:8084/repository/javaapp'){
                                sh '''
                                docker push 10.20.40.176:8084/frontapp
                                '''
                            }
                        }  
                }
                
                stage("Docker push Back image"){
                        steps{
                            withDockerRegistry(credentialsId: 'nexus_registry', url: 'http://10.20.40.176:8084/repository/javaapp'){
                                sh '''
                                docker push 10.20.40.176:8084/backapp
                                '''  
                            }
                        }  
                }
            
            }
        }


        stage("Deploy images from Nexus registry to front targets"){
            steps{
                
                    withDockerRegistry(credentialsId: 'nexus_registry', url: 'http://10.20.40.176:8084/repository/javaapp'){
                        sh "echo 'Docker login'"
                    }

                    withCredentials([string(credentialsId: 'AWS_ACCESS_KEY_ID', variable: 'AWS_ACCESS_KEY_ID'), string(credentialsId: 'AWS_SECRET_ACCESS_KEY', variable: 'AWS_SECRET_ACCESS_KEY')]){
                        script{
                            aws_access_key_id = env.AWS_ACCESS_KEY_ID
                            aws_secret_access_key = env.AWS_SECRET_ACCESS_KEY
                        } 
                    }
                    
                    withCredentials([string(credentialsId: 'NEXUS_USER_ID', variable: 'NEXUS_USER'), 
                        string(credentialsId: 'NEXUS_PASS_ID', variable: 'NEXUS_PASS'), 
                        string(credentialsId: 'NEXUS_URL_ID', variable: 'NEXUS_URL')]) {
                        sh 'ansible-playbook -i ci/ansible/ec2.py ci/ansible/front_deploy.yaml --extra-vars "user=${NEXUS_USER} pass=${NEXUS_PASS} url=${NEXUS_URL}"'        
                    }
            }  
        }


    }
    
        post{
            always{
                echo "========always========"
            }
            success{
                echo "========pipeline executed successfully ========"
            }
            failure{
                echo "========pipeline execution failed========"
            }
        }
}
